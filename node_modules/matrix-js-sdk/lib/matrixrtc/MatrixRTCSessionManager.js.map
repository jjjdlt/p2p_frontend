{"version":3,"file":"MatrixRTCSessionManager.js","names":["logger","ClientEvent","TypedEventEmitter","RoomEvent","RoomStateEvent","MatrixRTCSession","EventType","MatrixRTCSessionManagerEvents","MatrixRTCSessionManager","constructor","client","_defineProperty","Map","event","consumeCallEncryptionEvent","room","refreshRoom","_state","getRoom","getRoomId","error","concat","getType","GroupCallMemberPrefix","start","_this$client$getRooms","getRooms","session","roomSessionForRoom","memberships","length","roomSessions","set","roomId","on","Room","onRoom","Timeline","onTimeline","Events","onRoomState","stop","sess","values","clear","removeListener","getActiveRoomSession","get","getRoomSession","has","_this","_asyncToGenerator","decryptEventIfNeeded","CallEncryptionKeysPrefix","Promise","resolve","onCallEncryption","isNewSession","wasActiveAndKnown","onMembershipUpdate","nowActive","emit","SessionEnded","SessionStarted"],"sources":["../../src/matrixrtc/MatrixRTCSessionManager.ts"],"sourcesContent":["/*\nCopyright 2023 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport { logger } from \"../logger\";\nimport { MatrixClient, ClientEvent } from \"../client\";\nimport { TypedEventEmitter } from \"../models/typed-event-emitter\";\nimport { Room, RoomEvent } from \"../models/room\";\nimport { RoomState, RoomStateEvent } from \"../models/room-state\";\nimport { MatrixEvent } from \"../models/event\";\nimport { MatrixRTCSession } from \"./MatrixRTCSession\";\nimport { EventType } from \"../@types/event\";\n\nexport enum MatrixRTCSessionManagerEvents {\n    // A member has joined the MatrixRTC session, creating an active session in a room where there wasn't previously\n    SessionStarted = \"session_started\",\n    // All participants have left a given MatrixRTC session.\n    SessionEnded = \"session_ended\",\n}\n\ntype EventHandlerMap = {\n    [MatrixRTCSessionManagerEvents.SessionStarted]: (roomId: string, session: MatrixRTCSession) => void;\n    [MatrixRTCSessionManagerEvents.SessionEnded]: (roomId: string, session: MatrixRTCSession) => void;\n};\n\n/**\n * Holds all active MatrixRTC session objects and creates new ones as events arrive.\n * This interface is UNSTABLE and may change without warning.\n */\nexport class MatrixRTCSessionManager extends TypedEventEmitter<MatrixRTCSessionManagerEvents, EventHandlerMap> {\n    // All the room-scoped sessions we know about. This will include any where the app\n    // has queried for the MatrixRTC sessions in a room, whether it's ever had any members\n    // or not). We keep a (lazily created) session object for every room to ensure that there\n    // is only ever one single room session object for any given room for the lifetime of the\n    // client: that way there can never be any code holding onto a stale object that is no\n    // longer the correct session object for the room.\n    private roomSessions = new Map<string, MatrixRTCSession>();\n\n    public constructor(private client: MatrixClient) {\n        super();\n    }\n\n    public start(): void {\n        // We shouldn't need to null-check here, but matrix-client.spec.ts mocks getRooms\n        // returing nothing, and breaks tests if you change it to return an empty array :'(\n        for (const room of this.client.getRooms() ?? []) {\n            const session = MatrixRTCSession.roomSessionForRoom(this.client, room);\n            if (session.memberships.length > 0) {\n                this.roomSessions.set(room.roomId, session);\n            }\n        }\n\n        this.client.on(ClientEvent.Room, this.onRoom);\n        this.client.on(RoomEvent.Timeline, this.onTimeline);\n        this.client.on(RoomStateEvent.Events, this.onRoomState);\n    }\n\n    public stop(): void {\n        for (const sess of this.roomSessions.values()) {\n            sess.stop();\n        }\n        this.roomSessions.clear();\n\n        this.client.removeListener(ClientEvent.Room, this.onRoom);\n        this.client.removeListener(RoomEvent.Timeline, this.onTimeline);\n        this.client.removeListener(RoomStateEvent.Events, this.onRoomState);\n    }\n\n    /**\n     * Gets the main MatrixRTC session for a room, or undefined if there is\n     * no current session\n     */\n    public getActiveRoomSession(room: Room): MatrixRTCSession | undefined {\n        return this.roomSessions.get(room.roomId)!;\n    }\n\n    /**\n     * Gets the main MatrixRTC session for a room, returning an empty session\n     * if no members are currently participating\n     */\n    public getRoomSession(room: Room): MatrixRTCSession {\n        if (!this.roomSessions.has(room.roomId)) {\n            this.roomSessions.set(room.roomId, MatrixRTCSession.roomSessionForRoom(this.client, room));\n        }\n\n        return this.roomSessions.get(room.roomId)!;\n    }\n\n    private async consumeCallEncryptionEvent(event: MatrixEvent): Promise<void> {\n        await this.client.decryptEventIfNeeded(event);\n        if (event.getType() !== EventType.CallEncryptionKeysPrefix) return Promise.resolve();\n\n        const room = this.client.getRoom(event.getRoomId());\n        if (!room) {\n            logger.error(`Got room state event for unknown room ${event.getRoomId()}!`);\n            return Promise.resolve();\n        }\n\n        this.getRoomSession(room).onCallEncryption(event);\n    }\n    private onTimeline = (event: MatrixEvent): void => {\n        this.consumeCallEncryptionEvent(event);\n    };\n\n    private onRoom = (room: Room): void => {\n        this.refreshRoom(room);\n    };\n\n    private onRoomState = (event: MatrixEvent, _state: RoomState): void => {\n        const room = this.client.getRoom(event.getRoomId());\n        if (!room) {\n            logger.error(`Got room state event for unknown room ${event.getRoomId()}!`);\n            return;\n        }\n\n        if (event.getType() == EventType.GroupCallMemberPrefix) {\n            this.refreshRoom(room);\n        }\n    };\n\n    private refreshRoom(room: Room): void {\n        const isNewSession = !this.roomSessions.has(room.roomId);\n        const sess = this.getRoomSession(room);\n\n        const wasActiveAndKnown = sess.memberships.length > 0 && !isNewSession;\n\n        sess.onMembershipUpdate();\n\n        const nowActive = sess.memberships.length > 0;\n\n        if (wasActiveAndKnown && !nowActive) {\n            this.emit(MatrixRTCSessionManagerEvents.SessionEnded, room.roomId, this.roomSessions.get(room.roomId)!);\n        } else if (!wasActiveAndKnown && nowActive) {\n            this.emit(MatrixRTCSessionManagerEvents.SessionStarted, room.roomId, this.roomSessions.get(room.roomId)!);\n        }\n    }\n}\n"],"mappings":"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","ignoreList":[]}